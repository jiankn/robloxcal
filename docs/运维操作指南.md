# AFSE 工具站运维操作指南

## 1. 手动调用聚合任务

聚合任务用于汇总用户提交的校准样本，更新各训练区的参数（base_gain_per_min、confidence 等），让计算器越用越准。

### 1.1 什么时候需要手动调用？

- 有新用户提交了校准数据后
- 每隔几天定期执行一次
- 发现计算结果不准确时

### 1.2 调用方式

#### 方法 A：浏览器控制台（最简单）

1. 打开网站首页
2. 按 `F12` 打开开发者工具
3. 切换到 **Console** 标签
4. 粘贴以下代码并回车：

```javascript
fetch('/api/v1/cron/aggregate-training-params', {
  method: 'POST',
  headers: {
    'x-cron-secret': 'u2B3Zj+/vUW4JDXiViUavOuD5q1/WS9o4W4FRpeWxGY=',
    'Content-Type': 'application/json'
  }
}).then(r => r.json()).then(console.log);
```

5. 查看返回结果

#### 方法 B：PowerShell 命令行

```powershell
# 本地开发环境
node -e "fetch('http://localhost:3000/api/v1/cron/aggregate-training-params', { method: 'POST', headers: { 'x-cron-secret': 'u2B3Zj+/vUW4JDXiViUavOuD5q1/WS9o4W4FRpeWxGY=' } }).then(r => r.json()).then(console.log)"

# 生产环境（替换为你的域名）
node -e "fetch('https://你的域名.com/api/v1/cron/aggregate-training-params', { method: 'POST', headers: { 'x-cron-secret': 'u2B3Zj+/vUW4JDXiViUavOuD5q1/WS9o4W4FRpeWxGY=' } }).then(r => r.json()).then(console.log)"
```

#### 方法 C：使用 cURL（需要安装 curl.exe）

```bash
curl -X POST "https://你的域名.com/api/v1/cron/aggregate-training-params" \
  -H "x-cron-secret: u2B3Zj+/vUW4JDXiViUavOuD5q1/WS9o4W4FRpeWxGY=" \
  -H "Content-Type: application/json"
```

### 1.3 返回结果说明

成功执行后会返回：

```json
{
  "success": true,
  "message": "Aggregation completed",
  "version_key": "2026-01-13",
  "updated_count": 5,
  "total_areas": 54
}
```

| 字段 | 说明 |
|------|------|
| `success` | 是否执行成功 |
| `message` | 执行消息 |
| `version_key` | 当前游戏版本 |
| `updated_count` | 更新了多少个训练区参数 |
| `total_areas` | 总共扫描了多少个训练区 |

> ⚠️ 如果 `updated_count` 为 0，说明没有新的校准样本需要处理，这是正常的。

---

## 2. 配置自动定时任务（可选）

如果你想自动执行聚合任务，可以使用免费的在线 Cron 服务。

### 2.1 使用 cron-job.org

1. 访问 https://cron-job.org 并注册免费账号
2. 点击 **Create cronjob**
3. 填写配置：

| 字段 | 值 |
|------|-----|
| Title | AFSE Aggregation |
| URL | `https://你的域名/api/v1/cron/aggregate-training-params` |
| Schedule | Every 6 hours |
| Request method | POST |

4. 在 **Advanced** → **Headers** 中添加：
   - Name: `x-cron-secret`
   - Value: `u2B3Zj+/vUW4JDXiViUavOuD5q1/WS9o4W4FRpeWxGY=`

5. 保存

---

## 3. 常用 API 端点

| 端点 | 方法 | 描述 | 需要认证 |
|------|------|------|---------|
| `/api/v1/optimizer/config` | GET | 获取优化器配置 | 否 |
| `/api/v1/codes` | GET | 获取兑换码列表 | 否 |
| `/api/v1/calibrate` | POST | 提交校准样本 | 否 |
| `/api/v1/cron/aggregate-training-params` | POST | 执行聚合任务 | 是（需要 x-cron-secret） |

---

## 4. 环境变量说明

`.env.local` 文件中的配置：

```bash
# Supabase 数据库配置
NEXT_PUBLIC_SUPABASE_URL=你的Supabase项目URL
NEXT_PUBLIC_SUPABASE_ANON_KEY=你的anon公钥
SUPABASE_SERVICE_ROLE_KEY=你的service_role密钥

# Cron 任务密钥
CRON_SECRET=u2B3Zj+/vUW4JDXiViUavOuD5q1/WS9o4W4FRpeWxGY=

# 站点信息
NEXT_PUBLIC_SITE_URL=https://你的域名.com
NEXT_PUBLIC_SITE_NAME=AFSE Calculator
```

> ⚠️ **安全提示**：不要将 `.env.local` 文件提交到 Git，确保它在 `.gitignore` 中。

---

## 5. 部署到 Vercel

### 5.1 首次部署

```powershell
cd c:\antigravity\AFSE\afse-calculator
npx vercel --prod
```

### 5.2 配置环境变量

在 Vercel Dashboard → 你的项目 → Settings → Environment Variables 中添加所有环境变量。

### 5.3 后续更新

```powershell
git add .
git commit -m "更新说明"
git push

# 或直接部署
npx vercel --prod
```

---

## 6. 故障排查

### 问题：聚合 API 返回 401 Unauthorized

**原因**：CRON_SECRET 不匹配

**解决**：
1. 检查 `.env.local` 中的 `CRON_SECRET` 是否正确
2. 重启开发服务器（Ctrl+C 后重新 `pnpm dev`）
3. 确保请求头中的 `x-cron-secret` 与环境变量一致

### 问题：updated_count 始终为 0

**原因**：没有用户提交校准样本

**解决**：这是正常的，只有当用户通过 `/calibrate` 页面提交数据后，聚合任务才会更新参数。

### 问题：API 返回 500 错误

**原因**：数据库连接问题

**解决**：
1. 检查 Supabase 项目是否正常运行
2. 验证环境变量中的 Supabase 配置是否正确
3. 查看 Vercel/本地控制台的错误日志
